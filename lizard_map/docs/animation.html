<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>animation.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id="background"></div>
<div id='container'>
  
  <div class='section'>
    <div class='docs'><h1>animation.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      <p>Animation scrollbar handling.
import datetime</p>
<p>from django.http import Http404
from django.http import HttpResponse
from django.utils import simplejson as json</p>
<p>from lizard_map.daterange import current_start_end_dates
from lizard_map.daterange import DUTCH_DATE_FORMAT
from lizard_map.workspace import WorkspaceManager</p>
<p>ANIMATION_SETTINGS = 'animation_settings'</p>
<p>def slider_layout_extra(request):</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">Calculates</span> <span class="n">layout_extra</span> <span class="p">(</span><span class="n">used</span> <span class="n">when</span> <span class="n">drawing</span> <span class="n">graphs</span><span class="p">)</span> <span class="k">for</span> <span class="n">current</span>
    <span class="n">animation</span> <span class="n">slider</span><span class="o">.</span>

    <span class="n">Requires</span> <span class="n">request</span><span class="o">.</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <p>layout_extra = {}</p>
<p>workspace_manager = WorkspaceManager(request)
workspace_groups = workspace_manager.load_or_create()</p>
<p>for workspaces in workspace_groups.values():
<pre>for workspace in workspaces:
for workspace_item in workspace.workspace_items.filter(
visible=True):
if workspace_item.adapter.is_animatable:
animation_info = AnimationSettings(request).info()
if not 'vertical_lines' in layout_extra:
layout_extra['vertical_lines'] = []
vertical_line = {'name': 'Positie animatie slider',
'value': animation_info['selected_date'],
'style': {'linewidth': 3,
'linestyle': '--',
'color': 'green'}}
layout_extra['vertical_lines'].append(vertical_line)
return layout_extra
</pre></p>
<p>def set_animation_date(request):
Sets the animation date in the session</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">is_ajax</span><span class="p">():</span>
        <span class="n">animation_settings</span> <span class="o">=</span> <span class="n">AnimationSettings</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">animation_settings</span><span class="o">.</span><span class="n">slider_position</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">&#39;slider_value&#39;</span><span class="p">])</span>
        <span class="n">selected_date</span> <span class="o">=</span> <span class="n">animation_settings</span><span class="o">.</span><span class="n">info</span><span class="p">()[</span><span class="s">&#39;selected_date&#39;</span><span class="p">]</span>
        <span class="n">return_date</span> <span class="o">=</span> <span class="n">selected_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">DUTCH_DATE_FORMAT</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">return_date</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">Http404</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      <p>Handle animation settings in the session.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">AnimationSettings</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      <p>animation_slider has the value of [days from day_one], where
day_one is defined as year 1979, 25th of May (negative values are
allowed).</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      <p>Return info for creating the slider.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      <p>http://jqueryui.com/demos/slider needs a couple of settings for the
slider.  min/max for the start/end value.  We start at 0 and the max
is the number of days in the current date range.</p>
<p>The step is hardcoded to 1 (day) for now.</p>
<p>The value is the current position of the slider (in days from
day_one, just like the step size).</p>
<p>For visualisation, we also pass the current value as a datetime.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">selected_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">day_one</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slider_position</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      <p>Convert the date to datetime as we'll want that later on.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">selected_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">selected_date</span><span class="p">,</span>
                                                  <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">result</span><span class="p">[</span><span class="s">&#39;min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date_days</span>
        <span class="n">result</span><span class="p">[</span><span class="s">&#39;max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_date_days</span>
        <span class="n">result</span><span class="p">[</span><span class="s">&#39;step&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">result</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slider_position</span>
        <span class="n">result</span><span class="p">[</span><span class="s">&#39;selected_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected_date</span>
        <span class="k">return</span> <span class="n">result</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      <p>Store value in the session.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_set_slider_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div><div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      <h1>value = min(max(self.start_date_days, value), self.end_date_days)</h1>
<p>value = min(max(self.start_date_days, value), self.end_date_days)
self.request.session[ANIMATION_SETTINGS]['slider_position'] = value
self.request.session.modified = True</p>
<h1>^^^ .modified is only used in tests.</h1>
<p>def _get_slider_position(self):
Return value stored in the session.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="n">ANIMATION_SETTINGS</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s">&#39;slider_position&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_date_days</span><span class="p">)</span>

    <span class="n">slider_position</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_slider_position</span><span class="p">,</span> <span class="n">_set_slider_position</span><span class="p">)</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
