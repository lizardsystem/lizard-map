{% extends "lizard_map/lizardgis.html" %}{% load i18n %}

{% block map-javascript %}
  <script type="text/javascript">
    var layers, map;
    layers = [];
    {% block map-javascript-global %}
    {% endblock %}

    //layers is globally defined in wms.html
    function updateLayer(workspace_id) {
        layers[workspace_id].mergeNewParams({'random': Math.random()});
    }

    function updateLayers() {
        for (i=0; i<layers.length; i++) {
            if (layers[i] !== undefined) {
                updateLayer(i);
            }
        }
    }

    function showMap() {
        var options, openstreetmapLayer, MapClickControl, map_click_control;
        // Set up projection and bounds.
        options = {
            projection: new OpenLayers.Projection("EPSG:900913"),
            displayProjection: new OpenLayers.Projection("EPSG:4326"),
            units: "m",
            numZoomLevels: 18,
            //maxExtent: new OpenLayers.Bounds(-20037508, -20037508,
            //                                 20037508, 20037508.34),
            maxExtent: new OpenLayers.Bounds(129394,6659216,1335570,7306790)
        };
        map = new OpenLayers.Map('map', options);

        // Set up base layer.
        openstreetmapLayer = new OpenLayers.Layer.OSM(
            "Openstreetmap",
            "http://tah.openstreetmap.org/Tiles/tile/${z}/${x}/${y}.png",
            {buffer: 0});
        map.addLayer(openstreetmapLayer);

        // Add our own data layers.
        {% for workspace_list in workspaces.values %}
          {% for workspace in workspace_list %}
            layers[{{ workspace.id }}] = new OpenLayers.Layer.WMS(
                "{{ workspace.name }}",
                "{% url lizard_map_wms workspace_id=workspace.id %}",
                {layers: 'basic'},
                {singleTile: true,
                 isBaseLayer: false});
            map.addLayer(layers[{{ workspace.id }}]);
          {% endfor %}
        {% endfor %}

        // Set up controls, zoom and center.
        map.addControl(new OpenLayers.Control.LayerSwitcher({'ascending': false}));
        // Click handling.
        {% if javascript_click_handler %}
          MapClickControl = OpenLayers.Class(OpenLayers.Control, {
              defaultHandlerOptions: {
                  'single': true,
                  'double': false,
                  'pixelTolerance': 0,
                  'stopSingle': false,
                  'stopDouble': false
              },

              initialize: function(options) {
                  this.handlerOptions = OpenLayers.Util.extend(
                      {}, this.defaultHandlerOptions
                  );
                  OpenLayers.Control.prototype.initialize.apply(
                      this, arguments
                  );
                  this.handler = new OpenLayers.Handler.Click(
                      this, {
                          'click': this.trigger
                      }, this.handlerOptions
                  );
              },

              trigger: function(e) {
                  var lonlat;
                  lonlat = map.getLonLatFromViewPortPx(e.xy);
                  // map_click_handler comes from lizard_map.js.
                  {{ javascript_click_handler }}(lonlat.lon, lonlat.lat, map);
              }
          });
          map_click_control = new MapClickControl();
          map.addControl(map_click_control);
          map_click_control.activate();
        {% endif %}
        // Extend zooming.
        map.setCenter(new OpenLayers.LonLat(550000, 6850000), 10);
    }

    $(document).ready(showMap);
  </script>
{% endblock map-javascript %}

{# Should this block be zapped?  It *is* already in lizard-ui... #}
{% block sidebar %}
{% endblock sidebar %}

{% block above-content %}
<ul class="map-actions">
  {% if animation_slider %}
  <li id="animation-slider"
      class="map-action"
      data-min="{{ animation_slider.min }}"
      data-max="{{ animation_slider.max }}"
      data-step="{{ animation_slider.step }}"
      data-value="{{ animation_slider.value }}"
      data-ajax-path="{% url lizard_map.set_animation_date %}">
  </li>
  <li class="map-action">
    <span id="selected-date">{{ animation_slider.selected_date|date:"d/m/Y" }}</span>
  </li>
  {% endif %}
  {% for workspace_item in workspaces.temp.0.workspace_items.all %}
  <li class="workspace-empty-temp map-action"
      data-workspace-item-id="{{ workspace_item.id }}">
    <span class="ss_sprite ss_map_delete action-icon">
      {% trans "tijdelijke workspace legen" %}
    </span>
  </li>
  {% endfor %}
</ul>
{% endblock above-content %}
